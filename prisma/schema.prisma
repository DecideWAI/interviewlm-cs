generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                 String               @id @default(cuid())
  name               String?
  email              String               @unique
  emailVerified      DateTime?            @map("email_verified")
  image              String?
  password           String?
  role               UserRole             @default(USER)
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  accounts           Account[]
  assessments        Assessment[]
  candidates         Candidate[]
  organizationMember OrganizationMember[]
  sessions           Session[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id                   String               @id @default(cuid())
  name                 String
  slug                 String               @unique
  description          String?
  image                String?
  plan                 Plan                 @default(FREE)
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  credits              Int                  @default(0)

  // Subscription fields
  subscriptionStatus   String?              @map("subscription_status")
  paddleSubscriptionId String?              @unique @map("paddle_subscription_id")
  billingInterval      String?              @map("billing_interval")
  subscriptionEndsAt   DateTime?            @map("subscription_ends_at")

  assessments          Assessment[]
  candidates           Candidate[]
  creditTransactions   CreditTransaction[]
  members              OrganizationMember[]
  problemSeeds         ProblemSeed[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           OrgRole      @default(MEMBER)
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Assessment {
  id                  String               @id @default(cuid())
  organizationId      String               @map("organization_id")
  createdById         String               @map("created_by_id")
  title               String
  description         String?
  role                String
  seniority           Seniority
  duration            Int
  techStack           String[]             @default([])
  status              AssessmentStatus     @default(DRAFT)
  enableCoding        Boolean              @default(true) @map("enable_coding")
  enableTerminal      Boolean              @default(true) @map("enable_terminal")
  enableAI            Boolean              @default(true) @map("enable_ai")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  publishedAt         DateTime?            @map("published_at")
  previewLimit        Int                  @default(3) @map("preview_limit")
  previewSessionsUsed Int                  @default(0) @map("preview_sessions_used")
  questions           AssessmentQuestion[]
  createdBy           User                 @relation(fields: [createdById], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  candidates          Candidate[]

  @@map("assessments")
}

model AssessmentQuestion {
  id            String       @id @default(cuid())
  assessmentId  String       @map("assessment_id")
  problemSeedId String?      @map("problem_seed_id")
  order         Int
  title         String
  description   String
  difficulty    Difficulty
  timeLimit     Int?         @map("time_limit")
  type          QuestionType @default(CODING)
  assessment    Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  problemSeed   ProblemSeed? @relation(fields: [problemSeedId], references: [id])

  @@map("assessment_questions")
}

model ProblemSeed {
  id                String               @id @default(cuid())
  organizationId    String               @map("organization_id")
  title             String
  description       String
  difficulty        Difficulty
  category          String
  tags              String[]             @default([])
  starterCode       String?              @map("starter_code")
  testCode          String?              @map("test_code")
  language          String               @default("javascript")

  // Seed management fields
  createdBy         String?              @map("created_by") // User ID who created this seed
  status            String               @default("active") // active, draft, archived
  instructions      String?              // Detailed instructions for AI question generation
  topics            String[]             @default([]) // e.g., ["arrays", "recursion", "dynamic-programming"]
  estimatedTime     Int                  @default(30) @map("estimated_time") // Estimated time in minutes
  usageCount        Int                  @default(0) @map("usage_count") // Number of times used in assessments
  avgCandidateScore Float?               @map("avg_candidate_score") // Average candidate score (0-100)
  parentSeedId      String?              @map("parent_seed_id") // For cloned seeds (copy-on-write)
  isSystemSeed      Boolean              @default(false) @map("is_system_seed") // True for default system seeds

  // NEW: Incremental question generation fields
  seedType          String               @default("legacy") @map("seed_type") // "legacy" or "incremental"
  domain            String?              // e.g., "e-commerce", "social-media", "fintech"
  requiredTech      Json?                @map("required_tech") // { languages: [], frameworks: [], databases: [], tools: [] }
  baseProblem       Json?                @map("base_problem") // { title, description, starterCode, estimatedTime }
  progressionHints  Json?                @map("progression_hints") // { extensionTopics: [], simplificationTopics: [] }
  seniorityExpectations Json?            @map("seniority_expectations") // { junior: [], mid: [], senior: [], staff: [], principal: [] }

  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  questions         AssessmentQuestion[]
  organization      Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentSeed        ProblemSeed?         @relation("SeedClones", fields: [parentSeedId], references: [id], onDelete: SetNull)
  clonedSeeds       ProblemSeed[]        @relation("SeedClones")

  @@map("problem_seeds")
}

model Candidate {
  id                  String              @id @default(cuid())
  organizationId      String              @map("organization_id")
  assessmentId        String              @map("assessment_id")
  createdById         String              @map("created_by_id")
  name                String
  email               String
  phone               String?
  status              CandidateStatus     @default(INVITED)
  invitedAt           DateTime            @default(now()) @map("invited_at")
  startedAt           DateTime?           @map("started_at")
  completedAt         DateTime?           @map("completed_at")
  invitationToken     String?             @unique @map("invitation_token")
  invitationSentAt    DateTime?           @map("invitation_sent_at")
  invitationExpiresAt DateTime?           @map("invitation_expires_at")
  deadlineAt          DateTime?           @map("deadline_at")
  volumeId            String?             @map("volume_id")
  overallScore        Float?              @map("overall_score")
  codingScore         Float?              @map("coding_score")
  communicationScore  Float?              @map("communication_score")
  problemSolvingScore Float?              @map("problem_solving_score")
  sessionData         Json?               @map("session_data")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  isPreview           Boolean             @default(false) @map("is_preview")
  assessment          Assessment          @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  createdBy           User                @relation(fields: [createdById], references: [id])
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedQuestions  GeneratedQuestion[]
  sessionRecording    SessionRecording?
  evaluation          Evaluation?

  @@index([isPreview])
  @@map("candidates")
}

model SessionRecording {
  id                 String              @id @default(cuid())
  candidateId        String              @unique @map("candidate_id")
  startTime          DateTime            @default(now()) @map("start_time")
  endTime            DateTime?           @map("end_time")
  duration           Int?
  status             SessionStatus       @default(ACTIVE)
  eventCount         Int                 @default(0) @map("event_count")
  storagePath        String?             @map("storage_path")
  storageSize        Int?                @map("storage_size")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  claudeInteractions ClaudeInteraction[]
  codeSnapshots      CodeSnapshot[]
  events             SessionEvent[]
  candidate          Candidate           @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  testResults        TestResult[]
  terminalCommands   TerminalCommand[]

  @@index([candidateId])
  @@map("session_recordings")
}

model SessionEvent {
  id         String           @id @default(cuid())
  sessionId  String           @map("session_id")
  timestamp  DateTime         @default(now())
  type       String
  fileId     String?          @map("file_id")
  data       Json
  checkpoint Boolean          @default(false)
  session    SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([sessionId, checkpoint])
  @@map("session_events")
}

model ClaudeInteraction {
  id            String           @id @default(cuid())
  sessionId     String           @map("session_id")
  timestamp     DateTime         @default(now())
  role          String
  content       String
  model         String?
  inputTokens   Int?             @map("input_tokens")
  outputTokens  Int?             @map("output_tokens")
  latency       Int?
  stopReason    String?          @map("stop_reason")
  promptQuality Float?           @map("prompt_quality")
  session       SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@map("claude_interactions")
}

model CodeSnapshot {
  id               String           @id @default(cuid())
  sessionId        String           @map("session_id")
  timestamp        DateTime         @default(now())
  fileId           String           @map("file_id")
  fileName         String           @map("file_name")
  language         String
  contentHash      String           @map("content_hash")
  fullContent      String?          @map("full_content")
  diffFromPrevious Json?            @map("diff_from_previous")
  linesAdded       Int              @default(0) @map("lines_added")
  linesDeleted     Int              @default(0) @map("lines_deleted")
  session          SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([sessionId, fileId])
  @@map("code_snapshots")
}

model TestResult {
  id        String           @id @default(cuid())
  sessionId String           @map("session_id")
  timestamp DateTime         @default(now())
  testName  String           @map("test_name")
  passed    Boolean
  output    String?
  error     String?
  duration  Int?
  session   SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@map("test_results")
}

model GeneratedQuestion {
  id                    String         @id @default(cuid())
  candidateId           String         @map("candidate_id")
  questionSeedId        String?        @map("question_seed_id")
  order                 Int
  title                 String
  description           String
  difficulty            Difficulty
  language              String         @default("typescript")
  requirements          String[]       @default([])
  estimatedTime         Int            @map("estimated_time")
  starterCode           Json           @map("starter_code")
  testCases             Json           @map("test_cases")
  status                QuestionStatus @default(PENDING)
  startedAt             DateTime?      @map("started_at")
  completedAt           DateTime?      @map("completed_at")
  score                 Float?
  createdAt             DateTime       @default(now()) @map("created_at")

  // NEW: LLM difficulty assessment for fair scoring
  difficultyAssessment  Json?          @map("difficulty_assessment")

  candidate             Candidate      @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId, order])
  @@map("generated_questions")
}

model CreditTransaction {
  id              String          @id @default(cuid())
  organizationId  String          @map("organization_id")
  type            TransactionType
  amount          Int
  balanceAfter    Int             @map("balance_after")
  paddleOrderId   String?         @map("paddle_order_id")
  paddlePaymentId String?         @map("paddle_payment_id")
  amountPaid      Decimal?        @map("amount_paid") @db.Decimal(10, 2)
  currency        String?
  assessmentId    String?         @map("assessment_id")
  candidateId     String?         @map("candidate_id")
  description     String?
  metadata        Json?
  createdAt       DateTime        @default(now()) @map("created_at")
  createdBy       String?         @map("created_by")
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([paddleOrderId])
  @@index([assessmentId])
  @@map("credit_transactions")
}

model FailedJob {
  id            String   @id @default(cuid())
  jobId         String   @map("job_id")
  queueName     String   @map("queue_name")
  jobName       String   @map("job_name")
  jobData       Json     @map("job_data")
  error         Json     @map("error")
  errorMessage  String?  @map("error_message")
  errorStack    String?  @map("error_stack")
  attemptsMade  Int      @map("attempts_made")
  failedAt      DateTime @map("failed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([queueName])
  @@index([jobName])
  @@index([failedAt])
  @@map("failed_jobs")
}

enum UserRole {
  USER
  ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  STARTUP
  GROWTH
  ENTERPRISE
}

enum Seniority {
  JUNIOR
  MID
  SENIOR
  LEAD
  PRINCIPAL
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum AssessmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum QuestionType {
  CODING
  SYSTEM_DESIGN
  BEHAVIORAL
}

enum CandidateStatus {
  INVITED
  IN_PROGRESS
  COMPLETED
  EVALUATED
  HIRED
  REJECTED
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum QuestionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum TransactionType {
  PURCHASE
  DEDUCTION
  REFUND
  ADJUSTMENT
}

model Technology {
  id                String   @id @default(cuid())
  slug              String   @unique // e.g., "python", "react"
  name              String
  category          String   // "language", "framework", "database", "tool", "testing"
  icon              String?  // Lucide icon name
  description       String?
  color             String?  // Hex color code
  detectionPatterns Json?    @default("[]") // JSON array of patterns

  // Relationships
  pairedWithIds     String[] @default([]) // Array of IDs this tech is commonly paired with

  // Metadata
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("technologies")
}

// =====================================================
// EVALUATION SYSTEM
// Evidence-based evaluation results for interviews
// =====================================================

model Evaluation {
  id                       String   @id @default(cuid())
  candidateId              String   @map("candidate_id")
  sessionId                String   @unique @map("session_id")

  // 4-dimension scores (0-100)
  codeQualityScore         Int      @map("code_quality_score")
  codeQualityEvidence      Json     @map("code_quality_evidence")
  codeQualityConfidence    Float    @default(0.5) @map("code_quality_confidence")

  problemSolvingScore      Int      @map("problem_solving_score")
  problemSolvingEvidence   Json     @map("problem_solving_evidence")
  problemSolvingConfidence Float    @default(0.5) @map("problem_solving_confidence")

  aiCollaborationScore     Int      @map("ai_collaboration_score")
  aiCollaborationEvidence  Json     @map("ai_collaboration_evidence")
  aiCollaborationConfidence Float   @default(0.5) @map("ai_collaboration_confidence")

  communicationScore       Int      @map("communication_score")
  communicationEvidence    Json     @map("communication_evidence")
  communicationConfidence  Float    @default(0.5) @map("communication_confidence")

  // Overall metrics
  overallScore             Int      @map("overall_score")
  confidence               Float    @default(0.5)

  // Progressive scoring (multi-question assessments)
  progressiveScoreResult   Json?    @map("progressive_score_result")
  expertiseLevel           String?  @map("expertise_level") // beginner, intermediate, advanced, expert
  expertiseGrowth          Float?   @map("expertise_growth") // percentage point change
  expertiseGrowthTrend     String?  @map("expertise_growth_trend") // improving, declining, stable

  // Bias detection & fairness
  biasFlags                String[] @default([])
  confidenceMetrics        Json?    @map("confidence_metrics")
  biasDetection            Json?    @map("bias_detection")
  fairnessReport           String?  @map("fairness_report")

  // Hiring recommendation
  hiringRecommendation     String?  @map("hiring_recommendation") // strong_yes, yes, maybe, no, strong_no
  hiringConfidence         Float?   @map("hiring_confidence")
  hiringReasoning          Json?    @map("hiring_reasoning")

  // Actionable report (skills gap matrix, development roadmap, insights)
  actionableReport         Json?    @map("actionable_report")

  // Metadata
  model                    String   @default("claude-sonnet-4-20250514")
  evaluatedAt              DateTime @default(now()) @map("evaluated_at")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  candidate                Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([sessionId])
  @@index([overallScore])
  @@index([evaluatedAt])
  @@map("evaluations")
}

model TerminalCommand {
  id        String           @id @default(cuid())
  sessionId String           @map("session_id")
  timestamp DateTime         @default(now())
  command   String
  output    String?
  exitCode  Int              @default(0) @map("exit_code")
  duration  Int?             // Execution duration in ms
  category  String?          // Categorized command type
  session   SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@map("terminal_commands")
}
