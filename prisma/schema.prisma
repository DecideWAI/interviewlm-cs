generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                 String               @id @default(cuid())
  name               String?
  email              String               @unique
  emailVerified      DateTime?            @map("email_verified")
  image              String?
  password           String?
  role               UserRole             @default(USER)
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  accounts           Account[]
  assessments        Assessment[]
  candidates         Candidate[]
  organizationMember OrganizationMember[]
  sessions           Session[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  plan        Plan     @default(FREE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  credits     Int      @default(0)

  // Subscription fields
  subscriptionStatus   String?   @map("subscription_status")
  paddleSubscriptionId String?   @unique @map("paddle_subscription_id")
  billingInterval      String?   @map("billing_interval")
  subscriptionEndsAt   DateTime? @map("subscription_ends_at")

  assessments        Assessment[]
  candidates         Candidate[]
  creditTransactions CreditTransaction[]
  members            OrganizationMember[]
  problemSeeds       ProblemSeed[]
  complexityProfiles ComplexityProfile[]
  agentConfigs       AgentConfig[]

  // Config system relations
  configOverrides     ConfigOverride[]
  roleConfigs         RoleConfig[]
  seniorityConfigs    SeniorityConfig[]
  technologies        Technology[]
  assessmentTemplates AssessmentTemplateConfig[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           OrgRole      @default(MEMBER)
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Assessment {
  id                  String           @id @default(cuid())
  organizationId      String           @map("organization_id")
  createdById         String           @map("created_by_id")
  title               String
  description         String?
  role                String
  seniority           Seniority
  duration            Int
  techStack           String[]         @default([])
  status              AssessmentStatus @default(DRAFT)
  enableCoding        Boolean          @default(true) @map("enable_coding")
  enableTerminal      Boolean          @default(true) @map("enable_terminal")
  enableAI            Boolean          @default(true) @map("enable_ai")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  publishedAt         DateTime?        @map("published_at")
  previewLimit        Int              @default(10) @map("preview_limit")
  previewSessionsUsed Int              @default(0) @map("preview_sessions_used")

  // Evaluation settings
  evaluationThreshold Int     @default(70) @map("evaluation_threshold")
  requireEvaluation   Boolean @default(true) @map("require_evaluation")

  // Assessment type (Real World vs System Design)
  assessmentType AssessmentType @default(REAL_WORLD) @map("assessment_type")
  selectedSeedId String?        @map("selected_seed_id")

  questions    AssessmentQuestion[]
  createdBy    User                 @relation(fields: [createdById], references: [id])
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  candidates   Candidate[]

  @@map("assessments")
}

model AssessmentQuestion {
  id            String       @id @default(cuid())
  assessmentId  String       @map("assessment_id")
  problemSeedId String?      @map("problem_seed_id")
  order         Int
  title         String
  description   String
  difficulty    Difficulty
  timeLimit     Int?         @map("time_limit")
  type          QuestionType @default(CODING)
  assessment    Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  problemSeed   ProblemSeed? @relation(fields: [problemSeedId], references: [id])

  @@map("assessment_questions")
}

model ProblemSeed {
  id             String  @id @default(cuid())
  organizationId String? @map("organization_id") // Optional: null for system-wide seeds, set for org-specific seeds
  title          String
  description    String
  difficulty     Difficulty
  category       String
  tags           String[]   @default([])
  starterCode    String?    @map("starter_code")
  testCode       String?    @map("test_code")
  language       String     @default("javascript")

  // Seed management fields
  createdBy         String?  @map("created_by") // User ID who created this seed
  status            String   @default("active") // active, draft, archived
  instructions      String? // Detailed instructions for AI question generation
  topics            String[] @default([]) // e.g., ["arrays", "recursion", "dynamic-programming"]
  estimatedTime     Int      @default(30) @map("estimated_time") // Estimated time in minutes
  usageCount        Int      @default(0) @map("usage_count") // Number of times used in assessments
  avgCandidateScore Float?   @map("avg_candidate_score") // Average candidate score (0-100)
  parentSeedId      String?  @map("parent_seed_id") // For cloned seeds (copy-on-write)
  isSystemSeed      Boolean  @default(false) @map("is_system_seed") // True for default system seeds

  // NEW: Incremental question generation fields
  seedType              String  @default("legacy") @map("seed_type") // "legacy" or "incremental"
  domain                String? // e.g., "e-commerce", "social-media", "fintech"
  requiredTech          Json?   @map("required_tech") // { languages: [], frameworks: [], databases: [], tools: [] }
  baseProblem           Json?   @map("base_problem") // { title, description, starterCode, estimatedTime }
  progressionHints      Json?   @map("progression_hints") // { extensionTopics: [], simplificationTopics: [] }
  seniorityExpectations Json?   @map("seniority_expectations") // { junior: [], mid: [], senior: [], staff: [], principal: [] }

  // NEW: Assessment type targeting fields
  targetRole      String?         @map("target_role") // "backend", "frontend", "fullstack"
  targetSeniority String?         @map("target_seniority") // "junior", "mid", "senior", "staff", "principal"
  assessmentType  AssessmentType? @map("assessment_type") // REAL_WORLD or SYSTEM_DESIGN
  isDefaultSeed   Boolean         @default(false) @map("is_default_seed") // Canonical default for this combination

  // NEW: System Design specific fields
  designDocTemplate   Json?   @map("design_doc_template") // { sections: [], tradeoffs: [], constraints: [] }
  architectureHints   Json?   @map("architecture_hints") // { components: [], patterns: [], scalabilityGoals: [] }
  implementationScope String? @map("implementation_scope") // "api_skeleton", "core_service", "integration_layer"

  // NEW: Type-specific evaluation rubric
  evaluationRubric Json? @map("evaluation_rubric") // { type, criteria: [{ name, weight, description }] }

  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  questions    AssessmentQuestion[]
  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade) // Optional: null for system seeds
  parentSeed   ProblemSeed?         @relation("SeedClones", fields: [parentSeedId], references: [id], onDelete: SetNull)
  clonedSeeds  ProblemSeed[]        @relation("SeedClones")
  poolStats    QuestionPoolStats?

  @@index([targetRole, targetSeniority])
  @@index([assessmentType])
  @@index([organizationId]) // Index for querying org-specific + system seeds
  @@map("problem_seeds")
}

model Candidate {
  id                  String              @id @default(cuid())
  organizationId      String              @map("organization_id")
  assessmentId        String              @map("assessment_id")
  createdById         String              @map("created_by_id")
  name                String
  email               String
  phone               String?
  status              CandidateStatus     @default(INVITED)
  invitedAt           DateTime            @default(now()) @map("invited_at")
  startedAt           DateTime?           @map("started_at")
  completedAt         DateTime?           @map("completed_at")
  invitationToken     String?             @unique @map("invitation_token")
  invitationSentAt    DateTime?           @map("invitation_sent_at")
  invitationExpiresAt DateTime?           @map("invitation_expires_at")
  deadlineAt          DateTime?           @map("deadline_at")
  volumeId            String?             @map("volume_id")
  sandboxCreatedAt    DateTime?           @map("sandbox_created_at")
  sandboxLanguage     String?             @map("sandbox_language")
  overallScore        Float?              @map("overall_score")
  codingScore         Float?              @map("coding_score")
  communicationScore  Float?              @map("communication_score")
  problemSolvingScore Float?              @map("problem_solving_score")
  sessionData         Json?               @map("session_data")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  isPreview           Boolean             @default(false) @map("is_preview")
  assessment          Assessment          @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  createdBy           User                @relation(fields: [createdById], references: [id])
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedQuestions  GeneratedQuestion[]
  sessionRecording    SessionRecording?
  evaluation          Evaluation?

  @@index([isPreview])
  @@map("candidates")
}

model SessionRecording {
  id           String        @id @default(cuid())
  candidateId  String        @unique @map("candidate_id")
  startTime    DateTime      @default(now()) @map("start_time")
  endTime      DateTime?     @map("end_time")
  duration     Int?
  status       SessionStatus @default(ACTIVE)
  eventCount   Int           @default(0) @map("event_count")
  storagePath  String?       @map("storage_path")
  storageSize  Int?          @map("storage_size")
  trackedFiles Json          @default("[]") @map("tracked_files") // Array of file paths created during session

  // Agent backend assignment - persisted for entire session
  agentBackend AgentBackend? @map("agent_backend") // null = use default from AgentConfig
  experimentId String?       @map("experiment_id") // If assigned via experiment

  // Question generation backend assignment - persisted for entire session
  questionBackend      AgentBackend? @map("question_backend") // null = use default from AgentConfig
  questionExperimentId String?       @map("question_experiment_id") // If assigned via experiment

  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
  candidate Candidate         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  eventLog  SessionEventLog[] // Unified event store - single source of truth

  @@index([candidateId])
  @@index([agentBackend])
  @@map("session_recordings")
}

/// Unified Event Store - Single source of truth for all session events
/// Enables perfect replay fidelity, comprehensive evaluation, and rich analytics
model SessionEventLog {
  id             String      @id @default(cuid())
  sessionId      String      @map("session_id")
  sequenceNumber BigInt      @map("sequence_number") // Monotonically increasing per session
  timestamp      DateTime    // When the event occurred
  eventType      String      @map("event_type") @db.VarChar(50) // e.g., 'file.create', 'code.snapshot'
  category       String      @db.VarChar(20) // 'file', 'code', 'chat', 'terminal', 'test', 'session'
  origin         EventOrigin @default(SYSTEM) // Who triggered: USER, AI, or SYSTEM
  data           Json        // Event-specific payload
  questionIndex  Int?        @map("question_index") // Which question this event relates to
  filePath       String?     @map("file_path") @db.VarChar(500) // For file-related events
  checkpoint     Boolean     @default(false) // Marks significant moments for quick seeking
  createdAt      DateTime    @default(now()) @map("created_at")

  session SessionRecording @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, sequenceNumber])
  @@index([sessionId, timestamp])
  @@index([sessionId, sequenceNumber])
  @@index([eventType])
  @@index([category])
  @@index([origin])
  @@index([sessionId, questionIndex])
  @@map("session_event_log")
}

// DEPRECATED: Old event tables removed in favor of unified SessionEventLog
// The following tables were removed:
// - SessionEvent (now: session_event_log with eventType like 'session.*')
// - ClaudeInteraction (now: session_event_log with eventType like 'chat.*')
// - CodeSnapshot (now: session_event_log with eventType 'code.snapshot')
// - TestResult (now: session_event_log with eventType like 'test.*')

model GeneratedQuestion {
  id             String         @id @default(cuid())
  candidateId    String         @map("candidate_id")
  questionSeedId String?        @map("question_seed_id")
  order          Int
  title          String
  description    String
  difficulty     Difficulty
  language       String         @default("typescript")
  requirements   String[]       @default([])
  estimatedTime  Int            @map("estimated_time")
  starterCode    Json           @map("starter_code")
  testCases      Json           @map("test_cases")
  status         QuestionStatus @default(PENDING)
  startedAt      DateTime?      @map("started_at")
  completedAt    DateTime?      @map("completed_at")
  score          Float?
  createdAt      DateTime       @default(now()) @map("created_at")

  // NEW: LLM difficulty assessment for fair scoring
  difficultyAssessment Json? @map("difficulty_assessment")

  // Fast evaluation result - persisted for page reload recovery
  evaluationResult Json? @map("evaluation_result")

  // Infinite question generation fields
  fingerprint      String? // Hash for deduplication
  reuseCount       Int     @default(0) @map("reuse_count")
  parentQuestionId String? @map("parent_question_id")
  iterationNumber  Int     @default(0) @map("iteration_number") // 0 = original, 1+ = iteration

  candidate      Candidate           @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  parentQuestion GeneratedQuestion?  @relation("QuestionIterations", fields: [parentQuestionId], references: [id], onDelete: SetNull)
  iterations     GeneratedQuestion[] @relation("QuestionIterations")

  @@index([candidateId, order])
  @@index([questionSeedId, fingerprint])
  @@map("generated_questions")
}

model CreditTransaction {
  id              String          @id @default(cuid())
  organizationId  String          @map("organization_id")
  type            TransactionType
  amount          Int
  balanceAfter    Int             @map("balance_after")
  paddleOrderId   String?         @map("paddle_order_id")
  paddlePaymentId String?         @map("paddle_payment_id")
  amountPaid      Decimal?        @map("amount_paid") @db.Decimal(10, 2)
  currency        String?
  assessmentId    String?         @map("assessment_id")
  candidateId     String?         @map("candidate_id")
  description     String?
  metadata        Json?
  createdAt       DateTime        @default(now()) @map("created_at")
  createdBy       String?         @map("created_by")
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([paddleOrderId])
  @@index([assessmentId])
  @@map("credit_transactions")
}

model FailedJob {
  id           String   @id @default(cuid())
  jobId        String   @map("job_id")
  queueName    String   @map("queue_name")
  jobName      String   @map("job_name")
  jobData      Json     @map("job_data")
  error        Json     @map("error")
  errorMessage String?  @map("error_message")
  errorStack   String?  @map("error_stack")
  attemptsMade Int      @map("attempts_made")
  failedAt     DateTime @map("failed_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([queueName])
  @@index([jobName])
  @@index([failedAt])
  @@map("failed_jobs")
}

enum UserRole {
  USER
  ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  STARTUP
  GROWTH
  ENTERPRISE
}

enum Seniority {
  JUNIOR
  MID
  SENIOR
  LEAD
  PRINCIPAL
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum AssessmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum QuestionType {
  CODING
  SYSTEM_DESIGN
  BEHAVIORAL
}

enum AssessmentType {
  REAL_WORLD // Practical coding (implementation, tests, edge cases)
  SYSTEM_DESIGN // Hybrid (design doc + partial implementation)
}

enum CandidateStatus {
  INVITED
  IN_PROGRESS
  COMPLETED
  EVALUATED
  HIRED
  REJECTED
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

// Event origin - who/what triggered the event
enum EventOrigin {
  USER     // Candidate actions (typing, clicking, sending messages)
  AI       // AI agent actions (tool calls, responses)
  SYSTEM   // Platform actions (auto-save, timeouts, evaluations)
}

enum QuestionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum TransactionType {
  PURCHASE
  DEDUCTION
  REFUND
  ADJUSTMENT
}

enum AgentBackend {
  CLAUDE_SDK // TypeScript Anthropic SDK agents
  LANGGRAPH // Python LangGraph agents
}

model Technology {
  id          String  @id @default(cuid())
  slug        String // e.g., "python", "react"
  name        String
  category    String // "language", "framework", "database", "tool", "testing"
  icon        String? // Lucide icon name
  description String?
  color       String? // Hex color code

  // Detection patterns (expanded from detectionPatterns JSON)
  detectionPatterns Json?    @default("[]") @map("detection_patterns") // Legacy JSON format
  fileExtensions    String[] @default([]) @map("file_extensions") // [".py", ".pyi"]
  importPatterns    String[] @default([]) @map("import_patterns") // ["import ", "from "]
  contentPatterns   String[] @default([]) @map("content_patterns") // Additional detection patterns

  // Relationships
  pairedWithIds String[] @default([]) @map("paired_with_ids") // Array of IDs this tech is commonly paired with

  // Role-based relevance
  suggestedForRoles Json? @map("suggested_for_roles") // { backend: "critical", frontend: "optional" }

  // Multi-tenancy
  isActive       Boolean @default(true) @map("is_active")
  isSystem       Boolean @default(true) @map("is_system") // System = cannot delete
  organizationId String? @map("organization_id") // null = system-wide

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([slug, organizationId])
  @@index([category])
  @@index([isSystem])
  @@map("technologies")
}

// =====================================================
// EVALUATION SYSTEM
// Evidence-based evaluation results for interviews
// =====================================================

model Evaluation {
  id          String @id @default(cuid())
  candidateId String @unique @map("candidate_id")
  sessionId   String @unique @map("session_id")

  // 4-dimension scores (0-100)
  codeQualityScore      Int   @map("code_quality_score")
  codeQualityEvidence   Json  @map("code_quality_evidence")
  codeQualityConfidence Float @default(0.5) @map("code_quality_confidence")

  problemSolvingScore      Int   @map("problem_solving_score")
  problemSolvingEvidence   Json  @map("problem_solving_evidence")
  problemSolvingConfidence Float @default(0.5) @map("problem_solving_confidence")

  aiCollaborationScore      Int   @map("ai_collaboration_score")
  aiCollaborationEvidence   Json  @map("ai_collaboration_evidence")
  aiCollaborationConfidence Float @default(0.5) @map("ai_collaboration_confidence")

  communicationScore      Int   @map("communication_score")
  communicationEvidence   Json  @map("communication_evidence")
  communicationConfidence Float @default(0.5) @map("communication_confidence")

  // Overall metrics
  overallScore Int   @map("overall_score")
  confidence   Float @default(0.5)

  // Progressive scoring (multi-question assessments)
  progressiveScoreResult Json?   @map("progressive_score_result")
  expertiseLevel         String? @map("expertise_level") // beginner, intermediate, advanced, expert
  expertiseGrowth        Float?  @map("expertise_growth") // percentage point change
  expertiseGrowthTrend   String? @map("expertise_growth_trend") // improving, declining, stable

  // Bias detection & fairness
  biasFlags         String[] @default([])
  confidenceMetrics Json?    @map("confidence_metrics")
  biasDetection     Json?    @map("bias_detection")
  fairnessReport    String?  @map("fairness_report")

  // Hiring recommendation
  hiringRecommendation String? @map("hiring_recommendation") // strong_yes, yes, maybe, no, strong_no
  hiringConfidence     Float?  @map("hiring_confidence")
  hiringReasoning      Json?   @map("hiring_reasoning")

  // Actionable report (skills gap matrix, development roadmap, insights)
  actionableReport Json? @map("actionable_report")

  // Metadata
  model       String   @default("claude-sonnet-4-20250514")
  evaluatedAt DateTime @default(now()) @map("evaluated_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([sessionId])
  @@index([overallScore])
  @@index([evaluatedAt])
  @@map("evaluations")
}

// DEPRECATED: TerminalCommand table removed in favor of unified SessionEventLog
// Terminal commands are now stored as session_event_log with eventType like 'terminal.*'

// =====================================================
// INFINITE QUESTION GENERATION SYSTEM
// Track question pool statistics per seed for smart reuse
// =====================================================

model QuestionPoolStats {
  id              String    @id @default(cuid())
  seedId          String    @unique @map("seed_id")
  totalGenerated  Int       @default(0) @map("total_generated")
  uniqueQuestions Int       @default(0) @map("unique_questions")
  avgReuseCount   Float     @default(0) @map("avg_reuse_count")
  lastGeneratedAt DateTime? @map("last_generated_at")
  threshold       Int       @default(100) // Per-seed threshold for reuse mode

  // Stats for marketing/reporting
  totalCandidatesServed Int   @default(0) @map("total_candidates_served")
  avgUniquenessScore    Float @default(1.0) @map("avg_uniqueness_score")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  seed ProblemSeed @relation(fields: [seedId], references: [id], onDelete: Cascade)

  @@map("question_pool_stats")
}

// =====================================================
// BIAS DETECTION & FAIRNESS AUDIT SYSTEM
// Comprehensive audit logging for bias checks
// =====================================================

model BiasAuditLog {
  id           String  @id @default(cuid())
  sessionId    String  @map("session_id")
  candidateId  String  @map("candidate_id")
  evaluationId String? @map("evaluation_id")

  checkType      String   @map("check_type") // 'full_evaluation', 'dimension_check', 'pre_hire'
  inputs         Json // Sanitized inputs to bias detection
  result         Json // Full BiasDetectionResult
  riskLevel      String   @map("risk_level") // 'low' | 'medium' | 'high'
  biasesDetected String[] @default([]) @map("biases_detected") // Array of bias type codes

  // Human review workflow
  humanReviewed Boolean   @default(false) @map("human_reviewed")
  reviewerId    String?   @map("reviewer_id")
  reviewNotes   String?   @map("review_notes")
  reviewedAt    DateTime? @map("reviewed_at")
  reviewOutcome String?   @map("review_outcome") // 'approved', 'flagged', 'adjusted'

  createdAt DateTime @default(now()) @map("created_at")

  @@index([candidateId])
  @@index([riskLevel])
  @@index([createdAt])
  @@index([humanReviewed, riskLevel])
  @@map("bias_audit_logs")
}

// =====================================================
// DYNAMIC QUESTION GENERATION SYSTEM
// Complexity profiles for generic, truly dynamic question generation
// =====================================================

model ComplexityProfile {
  id String @id @default(cuid())

  // Targeting - defines which assessments use this profile
  role           String // "backend", "frontend", "fullstack"
  seniority      String // "junior", "mid", "senior", "staff", "principal"
  assessmentType AssessmentType

  // Complexity dimensions - what makes a problem harder
  entityCountMin    Int    @default(1) @map("entity_count_min")
  entityCountMax    Int    @default(2) @map("entity_count_max")
  integrationPoints Int    @default(0) @map("integration_points")
  businessLogic     String @default("simple") @map("business_logic") // simple, moderate, complex, strategic
  ambiguityLevel    String @default("clear") @map("ambiguity_level") // clear, some_decisions, open_ended, strategic
  timeMinutes       Int    @default(45) @map("time_minutes")

  // Skill configuration (JSON arrays)
  requiredSkills    Json @map("required_skills") // ["crud", "validation", "error_handling"]
  optionalSkillPool Json @map("optional_skill_pool") // ["auth", "caching", "pagination"]
  avoidSkills       Json @map("avoid_skills") // ["ml", "realtime"]
  pickOptionalCount Int  @default(2) @map("pick_optional_count")

  // Domain pool - LLM picks randomly from this list
  domainPool Json @map("domain_pool") // ["e-commerce", "healthcare", "fintech", ...]

  // Structural constraints (JSON object)
  constraints Json // { mustInclude: [], shouldConsider: [], bonus: [] }

  // Profile metadata
  isDefault      Boolean @default(false) @map("is_default")
  organizationId String? @map("organization_id") // null = system default, set = org override

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([role, seniority, assessmentType, organizationId])
  @@index([role, seniority, assessmentType])
  @@map("complexity_profiles")
}

// =====================================================
// AGENT CONFIGURATION SYSTEM
// DB-controllable agent backend selection with experiments
// =====================================================

model AgentConfig {
  id String @id @default(cuid())

  // Scope - determines which sessions use this config
  organizationId String? @map("organization_id") // null = global default
  assessmentId   String? @map("assessment_id") // optional: per-assessment override

  // Default backend when no experiment is active
  defaultBackend AgentBackend @default(LANGGRAPH) @map("default_backend")

  // Feature flags
  enableExperiments Boolean      @default(false) @map("enable_experiments")
  fallbackBackend   AgentBackend @default(LANGGRAPH) @map("fallback_backend") // Used if experiment errors

  // Rate limiting / load balancing (for coding agent)
  langGraphWeight Int @default(100) @map("langgraph_weight") // 0-100 weight for LangGraph
  claudeSdkWeight Int @default(0) @map("claude_sdk_weight") // 0-100 weight for Claude SDK

  // Question Generation Backend Configuration
  questionDefaultBackend    AgentBackend @default(CLAUDE_SDK) @map("question_default_backend")
  questionEnableExperiments Boolean      @default(false) @map("question_enable_experiments")
  questionLangGraphWeight   Int          @default(0) @map("question_langgraph_weight") // 0-100 weight for LangGraph
  questionClaudeSdkWeight   Int          @default(100) @map("question_claude_sdk_weight") // 0-100 weight for TypeScript

  // Metadata
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String?  @map("created_by")

  // Relations
  organization        Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  experiments         AgentExperiment[]
  questionExperiments QuestionExperiment[]

  @@unique([organizationId, assessmentId])
  @@index([isActive])
  @@map("agent_configs")
}

model AgentExperiment {
  id          String  @id @default(cuid())
  configId    String  @map("config_id")
  name        String
  description String?

  // Experiment variants
  controlBackend   AgentBackend @default(LANGGRAPH) @map("control_backend")
  treatmentBackend AgentBackend @default(CLAUDE_SDK) @map("treatment_backend")

  // Traffic allocation (percentage 0-100)
  controlPercent   Int @default(50) @map("control_percent")
  treatmentPercent Int @default(50) @map("treatment_percent")

  // Experiment lifecycle
  status    ExperimentStatus @default(DRAFT)
  startedAt DateTime?        @map("started_at")
  endedAt   DateTime?        @map("ended_at")

  // Metrics tracking
  controlSessions   Int    @default(0) @map("control_sessions")
  treatmentSessions Int    @default(0) @map("treatment_sessions")
  controlAvgScore   Float? @map("control_avg_score")
  treatmentAvgScore Float? @map("treatment_avg_score")

  // Targeting rules (JSON)
  targetingRules Json? @map("targeting_rules") // { seniorityIn: [], roleIn: [], assessmentTypeIn: [] }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // Relations
  config      AgentConfig                 @relation(fields: [configId], references: [id], onDelete: Cascade)
  assignments AgentExperimentAssignment[]

  @@index([configId, status])
  @@index([status])
  @@map("agent_experiments")
}

model AgentExperimentAssignment {
  id           String @id @default(cuid())
  experimentId String @map("experiment_id")
  sessionId    String @unique @map("session_id") // Links to SessionRecording.id
  candidateId  String @map("candidate_id")

  // Assignment details
  variant         String // "control" or "treatment"
  assignedBackend AgentBackend @map("assigned_backend")
  assignedAt      DateTime     @default(now()) @map("assigned_at")

  // Outcome tracking (populated after session)
  sessionCompleted Boolean   @default(false) @map("session_completed")
  overallScore     Float?    @map("overall_score")
  completedAt      DateTime? @map("completed_at")

  // Relations
  experiment AgentExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId, variant])
  @@index([candidateId])
  @@map("agent_experiment_assignments")
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

// =====================================================
// QUESTION GENERATION EXPERIMENT SYSTEM
// DB-controllable question generation backend selection
// =====================================================

model QuestionExperiment {
  id          String  @id @default(cuid())
  configId    String  @map("config_id")
  name        String
  description String?

  // Experiment variants (CLAUDE_SDK = TypeScript, LANGGRAPH = Python)
  controlBackend   AgentBackend @default(CLAUDE_SDK) @map("control_backend")
  treatmentBackend AgentBackend @default(LANGGRAPH) @map("treatment_backend")

  // Traffic allocation (percentage 0-100)
  controlPercent   Int @default(50) @map("control_percent")
  treatmentPercent Int @default(50) @map("treatment_percent")

  // Experiment lifecycle
  status    ExperimentStatus @default(DRAFT)
  startedAt DateTime?        @map("started_at")
  endedAt   DateTime?        @map("ended_at")

  // Metrics tracking
  controlSessions     Int    @default(0) @map("control_sessions")
  treatmentSessions   Int    @default(0) @map("treatment_sessions")
  controlAvgLatency   Float? @map("control_avg_latency") // ms
  treatmentAvgLatency Float? @map("treatment_avg_latency") // ms

  // Targeting rules (JSON)
  targetingRules Json? @map("targeting_rules") // { seniorityIn: [], roleIn: [], assessmentTypeIn: [] }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // Relations
  config      AgentConfig                    @relation(fields: [configId], references: [id], onDelete: Cascade)
  assignments QuestionExperimentAssignment[]

  @@index([configId, status])
  @@index([status])
  @@map("question_experiments")
}

model QuestionExperimentAssignment {
  id           String @id @default(cuid())
  experimentId String @map("experiment_id")
  sessionId    String @unique @map("session_id") // Links to SessionRecording.id
  candidateId  String @map("candidate_id")

  // Assignment details
  variant         String // "control" or "treatment"
  assignedBackend AgentBackend @map("assigned_backend")
  assignedAt      DateTime     @default(now()) @map("assigned_at")

  // Outcome tracking (populated after question generation)
  generationLatency Float?  @map("generation_latency") // ms
  questionId        String? @map("question_id") // Generated question ID

  // Relations
  experiment QuestionExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId, variant])
  @@index([candidateId])
  @@map("question_experiment_assignments")
}

// =====================================================
// CENTRALIZED CONFIG SYSTEM
// Database-driven configuration with layered overrides
// =====================================================

enum OverridePolicy {
  SYSTEM_ONLY // Cannot be overridden by organizations
  BOUNDED // Can be overridden within min/max constraints
  FULLY_CUSTOMIZABLE // Full organization control
}

model ConfigCategory {
  id             String         @id @default(cuid())
  name           String         @unique // e.g., "security", "models", "tech_catalog"
  description    String?
  overridePolicy OverridePolicy @default(SYSTEM_ONLY)

  configItems ConfigItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("config_categories")
}

model ConfigItem {
  id         String @id @default(cuid())
  categoryId String @map("category_id")
  key        String // e.g., "RATE_LIMITS.aiMessagesPerMinute"
  value      Json // Actual config value
  valueType  String // "number", "string", "array", "object"

  // Constraints for BOUNDED configs
  minValue      Float? @map("min_value")
  maxValue      Float? @map("max_value")
  allowedValues Json?  @map("allowed_values") // For enum-like constraints

  // Metadata
  description String?
  isActive    Boolean @default(true) @map("is_active")

  category  ConfigCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  overrides ConfigOverride[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([categoryId, key])
  @@map("config_items")
}

model ConfigOverride {
  id             String @id @default(cuid())
  configItemId   String @map("config_item_id")
  organizationId String @map("organization_id")
  value          Json // Override value

  // Audit trail
  createdBy  String?   @map("created_by")
  approvedBy String?   @map("approved_by") // For sensitive configs
  approvedAt DateTime? @map("approved_at")
  reason     String?

  configItem   ConfigItem   @relation(fields: [configItemId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([configItemId, organizationId])
  @@map("config_overrides")
}

// =====================================================
// SECURITY CONFIG (SYSTEM_ONLY)
// Blocked commands, allowed commands, rate limits
// =====================================================

model SecurityConfig {
  id          String  @id @default(cuid())
  configType  String  @unique @map("config_type") // "blocked_patterns", "allowed_commands", "rate_limits", "session_timeouts"
  value       Json
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("security_configs")
}

// =====================================================
// MODEL CONFIG
// Claude model configurations with pricing
// =====================================================

model ModelConfig {
  id                   String  @id @default(cuid())
  modelId              String  @unique @map("model_id") // e.g., "claude-sonnet-4-5-20250929"
  name                 String
  inputPricePerMToken  Float   @map("input_price_per_m_token")
  outputPricePerMToken Float   @map("output_price_per_m_token")
  maxTokens            Int     @map("max_tokens")
  contextWindow        Int     @map("context_window")
  description          String?
  useCase              String? @map("use_case")

  // Agent recommendations
  recommendedFor String[] @default([]) @map("recommended_for") // ["codingAgent", "evaluationAgent"]

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("model_configs")
}

// =====================================================
// SANDBOX CONFIG
// Per-language Docker images and resource limits
// =====================================================

model SandboxConfig {
  id          String @id @default(cuid())
  language    String @unique // e.g., "python", "javascript", "default"
  dockerImage String @map("docker_image")

  // Resource limits
  cpu            Float @default(2.0)
  memoryMb       Int   @default(2048) @map("memory_mb")
  timeoutSeconds Int   @default(3600) @map("timeout_seconds")

  // Constraints for BOUNDED org overrides
  maxCpu            Float @default(4.0) @map("max_cpu")
  maxMemoryMb       Int   @default(4096) @map("max_memory_mb")
  maxTimeoutSeconds Int   @default(7200) @map("max_timeout_seconds")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sandbox_configs")
}

// =====================================================
// ROLE CONFIG
// Role definitions (Backend, Frontend, Full-Stack, etc.)
// =====================================================

model RoleConfig {
  id               String   @id @default(cuid())
  roleId           String   @map("role_id") // "backend", "frontend", "fullstack", etc.
  name             String
  description      String?
  icon             String? // Lucide icon name
  defaultDuration  Int      @default(60) @map("default_duration")
  availableInTiers String[] @default([]) @map("available_in_tiers")
  status           String   @default("active") // "active", "coming_soon"

  // Multi-tenancy
  isSystem       Boolean @default(true) @map("is_system")
  organizationId String? @map("organization_id")

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([roleId, organizationId])
  @@index([isSystem])
  @@map("role_configs")
}

// =====================================================
// SENIORITY CONFIG
// Seniority levels with scoring weights
// =====================================================

model SeniorityConfig {
  id              String  @id @default(cuid())
  seniorityId     String  @map("seniority_id") // "junior", "mid", "senior", "staff", "principal"
  name            String
  description     String?
  experienceYears String? @map("experience_years")
  defaultDuration Int     @default(60) @map("default_duration")

  // Difficulty distribution
  difficultyMix Json @map("difficulty_mix") // { easy: 60, medium: 30, hard: 10 }

  // Scoring weights (from scoring.ts)
  scoringWeights Json? @map("scoring_weights") // { technical: 0.35, aiCollaboration: 0.30, ... }

  // Multi-tenancy
  isSystem       Boolean @default(true) @map("is_system")
  organizationId String? @map("organization_id")

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([seniorityId, organizationId])
  @@index([isSystem])
  @@map("seniority_configs")
}

// Tier configuration - pricing tiers and their limits
model TierConfig {
  id                        String  @id @default(cuid())
  tierId                    String  @unique @map("tier_id") // "payg", "small", "medium", "large", "enterprise"
  name                      String
  price                     Float // per assessment
  description               String?
  maxCustomQuestions        Int?    @map("max_custom_questions") // null = unlimited
  maxTeamMembers            Int?    @map("max_team_members") // null = unlimited
  customRolesAllowed        Boolean @default(false) @map("custom_roles_allowed")
  customInstructionsAllowed Boolean @default(false) @map("custom_instructions_allowed")
  advancedAnalytics         Boolean @default(false) @map("advanced_analytics")
  previewTestRuns           Int?    @map("preview_test_runs") // null = unlimited
  isActive                  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tier_configs")
}

// =====================================================
// PRICING PLANS (Paddle Products)
// Database-driven Paddle product configuration
// Replaces hardcoded env vars for dynamic pricing
// =====================================================

model PricingPlan {
  id String @id @default(cuid())

  // Plan identification
  slug        String  @unique // "single", "medium", "enterprise"
  name        String // "Single Assessment", "50 Assessments", etc.
  description String?

  // Paddle integration
  paddleProductId String  @map("paddle_product_id") // Paddle price ID (e.g., "pri_01hzf9kj")
  paddlePriceId   String? @map("paddle_price_id") // Optional: separate price ID if different

  // Pricing details
  credits        Int // Number of credits included
  price          Decimal @db.Decimal(10, 2) // Display price (e.g., 20.00, 750.00)
  currency       String  @default("USD")
  pricePerCredit Decimal @map("price_per_credit") @db.Decimal(10, 2) // For display (e.g., 20.00, 15.00)

  // Display configuration
  sortOrder Int     @default(0) @map("sort_order")
  isPopular Boolean @default(false) @map("is_popular") // Highlight badge
  badge     String? // Optional badge text ("Best Value", "Most Popular")
  features  Json    @default("[]") // Array of feature strings for display

  // Plan type
  planType        PlanType @default(ONE_TIME) @map("plan_type")
  billingInterval String?  @map("billing_interval") // "monthly", "yearly" for subscriptions

  // Availability
  isActive       Boolean   @default(true) @map("is_active")
  availableFrom  DateTime? @map("available_from")
  availableUntil DateTime? @map("available_until")

  // Audit trail
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  @@index([isActive, sortOrder])
  @@index([planType])
  @@map("pricing_plans")
}

enum PlanType {
  ONE_TIME // Credit pack purchase
  SUBSCRIPTION // Recurring subscription
}

// =====================================================
// ASSESSMENT ADD-ONS
// Premium features that can be added to any assessment
// Purchased separately at time of assessment
// =====================================================

model AssessmentAddOn {
  id String @id @default(cuid())

  // Add-on identification
  slug        String  @unique // "video-recording", "live-proctoring"
  name        String // "Video Recording", "Live Proctoring"
  description String?

  // Pricing
  price    Decimal @db.Decimal(10, 2) // Per-assessment price
  currency String  @default("USD")

  // Display
  icon      String? // Lucide icon name (e.g., "Video", "Shield")
  sortOrder Int     @default(0) @map("sort_order")
  features  Json    @default("[]") // Feature bullet points

  // Paddle integration (if separate product)
  paddleProductId String? @map("paddle_product_id")

  // Availability
  isActive Boolean @default(true) @map("is_active")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive, sortOrder])
  @@map("assessment_addons")
}

// Assessment templates - pre-built question templates
model AssessmentTemplateConfig {
  id                String  @id @default(cuid())
  templateId        String  @unique @map("template_id") // "backend-junior", etc.
  name              String
  role              String // "backend", "frontend", etc.
  seniority         String // "junior", "mid", "senior", etc.
  description       String?
  estimatedDuration Int     @map("estimated_duration")
  problemCount      Int     @map("problem_count")
  minTier           String  @map("min_tier") // minimum tier required
  questionSeeds     Json    @map("question_seeds") // Array of question seed objects
  isActive          Boolean @default(true) @map("is_active")
  isSystem          Boolean @default(true) @map("is_system")
  organizationId    String? @map("organization_id")

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([role, seniority])
  @@index([isSystem])
  @@map("assessment_template_configs")
}
